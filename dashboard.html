<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Inacap Day 0</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="dashboard-style.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

    <nav class="navbar">
        <div class="navbar-brand">
            <img src="mascot.png" alt="Mascota" class="nav-mascot">
            <span>Inacap Day 0</span>
        </div>
        <div class="nav-menu">
            <span id="nav-username"></span>
            <a href="dashboard.html" class="nav-btn active">Panel</a>
            <a href="missions.html" class="nav-btn">Misiones</a>
            <button id="logout-button" class="logout-btn">Cerrar Sesi贸n</button>
        </div>
    </nav>

    <main class="main-container">

        <h1 id="welcome-title">隆Hola, ...!</h1>

        <div class="widgets-grid">
            <div class="widget points-card">
                <h2>Inacapuntos</h2>
                <div class="points-display">
                    <img src="inacapuntos.png" alt="Moneda" class="coin-icon-img">
                    <span id="points-amount">0</span>
                </div>
            </div>

            <div class="widget qr-card">
                <h2>Escanear QR</h2>
                <p>Encuentra c贸digos en la sede para ganar puntos extra.</p>
                <button class="widget-btn" id="btn-scan-qr"> Abrir C谩mara</button>
            </div>
            
            <div class="widget map-card">
                <h2>Mapa Sede</h2>
                <p>Explora la sede y encuentra tus salas.</p>
                <button class="widget-btn">Ver Mapa</button>
            </div>
        </div> 

        <div class="widget mission-link-card" onclick="location.href='missions.html'">
            <h2>M贸dulos de Aprendizaje</h2>
            <p>Completa los m贸dulos de 7 preguntas para avanzar.</p>
            <button class="widget-btn">Ir a los M贸dulos</button>
        </div>

    </main>

    <div id="qr-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Escanear C贸digo</h2>
            <div id="reader" style="width: 100%;"></div>
            <p id="qr-result-text">Apunta tu c谩mara al c贸digo QR</p>
            <button id="close-qr-btn" class="widget-btn" style="background-color: #555; margin-top: 10px;">Cerrar C谩mara</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('accessToken');
        const username = localStorage.getItem('username');

        if (!token) { window.location.href = 'login.html'; return; }
    
            fetchUserData(token);

        // --- LGICA QR ---
        const qrModal = document.getElementById('qr-modal');
        const successModal = document.getElementById('success-modal'); // Nuevo modal
        const btnScanQr = document.getElementById('btn-scan-qr');
        const btnCloseQr = document.getElementById('close-qr-btn');
        const qrResultText = document.getElementById('qr-result-text');
        let html5QrcodeScanner = null;

        btnScanQr.addEventListener('click', () => {
            qrModal.style.display = 'flex';
            startScanner();
        });

        btnCloseQr.addEventListener('click', () => {
            stopScanner();
            qrModal.style.display = 'none';
        });

        // Funci贸n global para cerrar el modal de 茅xito
        window.closeSuccessModal = function() {
            successModal.style.display = 'none';
            qrModal.style.display = 'none'; // Cierra tambi茅n la c谩mara
        };

        function startScanner() {
            // Configuramos el esc谩ner
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", { fps: 10, qrbox: 250 }
            );
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch(error => console.error(error));
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            // 1. Detenemos el escaneo para que no lea dos veces
            stopScanner(); 
            qrResultText.textContent = "Procesando...";

            let missionId = decodedText;
            let points = 50; // Puntos por defecto si es un QR normal
            let message = "隆C贸digo escaneado exitosamente!";

            // 2. Intentamos leer el formato JSON (El QR inteligente)
            try {
                const data = JSON.parse(decodedText);
                // Si es un JSON v谩lido, usamos sus datos
                if(data.id && data.puntos) {
                    missionId = data.id;
                    points = data.puntos;
                    message = data.mensaje || message;
                }
            } catch (e) {
                // Si falla (es un QR de texto normal), usamos los valores por defecto
                console.log("QR de texto simple detectado");
            }
        
            // 3. Enviamos al Backend
            const success = await completeMissionOnBackend(missionId, points);
            
            if (success) {
                // 4. Mostrar el Modal de xito con el mensaje personalizado
                document.getElementById('success-modal-msg').textContent = message;
                document.getElementById('success-modal-points').textContent = points;
                successModal.style.display = 'flex';
                
                // Actualizar puntos en la barra
                fetchUserData(token); 
            } else {
                alert("Error: Este c贸digo ya fue escaneado o no es v谩lido.");
                qrModal.style.display = 'none';
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
        stopScanner(); 
        qrResultText.textContent = "Procesando...";

        let missionId = decodedText;
        let points = 50; 
        let successMsg = "隆C贸digo escaneado exitosamente!";

        try {
            const data = JSON.parse(decodedText);
            if(data.id && data.puntos) {
                missionId = data.id;
                points = data.puntos;
                successMsg = data.mensaje || successMsg;
            }
        } catch (e) { console.log("QR simple"); }
        
        // Llamamos al backend
        const result = await completeMissionOnBackend(missionId, points);
        
        if (result.success) {
            // XITO: Mostrar modal bonito
            document.getElementById('success-modal-msg').textContent = successMsg;
            document.getElementById('success-modal-points').textContent = points;
            document.getElementById('success-modal').style.display = 'flex';
            fetchUserData(token); 
        } else {
            // ERROR (YA ESCANEADO): Mostrar alerta con el mensaje del backend
            alert("Aviso: " + result.message); 
            // "隆Ya completaste esta misi贸n anteriormente!..."
            qrModal.style.display = 'none';
        }
    }

        // --- FUNCIONES EXISTENTES ---
        document.getElementById('logout-button').addEventListener('click', () => {
            localStorage.clear();
            window.location.href = 'login.html';
        });

        async function fetchUserData(token) {
            try {
                const response = await fetch('https://day-0-git.onrender.com/api/users/me', {
                    method: 'GET', headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const userData = await response.json();
                    document.getElementById('points-amount').textContent = userData.puntos;
                    document.getElementById('welcome-title').textContent = `隆Hola, ${userData.username}!`;
                    document.getElementById('nav-username').textContent = `Usuario: ${userData.username}`;
                }
            } catch (error) { console.error(error); }
        }

        async function completeMissionOnBackend(missionName, pointsToAdd) {
        try {
            const response = await fetch('https://day-0-git.onrender.com/api/missions/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ missionName: missionName, pointsToAdd: pointsToAdd })
            });

            const data = await response.json(); // Leemos la respuesta siempre

            if (!response.ok) {
                // Si fall贸 (ej. ya escaneado), devolvemos success: false y el mensaje del servidor
                return { success: false, message: data.message };
            }
            
            return { success: true, message: data.message };

        } catch (error) { 
            return { success: false, message: "Error de conexi贸n con el servidor." }; 
        }
    }
            });
    </script>

    <div id="success-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h2>隆Enhorabuena! </h2>
        <p id="success-modal-msg" style="font-size: 1.1em; margin: 20px 0;"></p>
        <h3 style="color: var(--color-red);">+<span id="success-modal-points"></span> Puntos</h3>
        <button onclick="closeSuccessModal()" class="widget-btn" style="margin-top: 20px;">Aceptar</button>
    </div>
</div>

</body>
</html>