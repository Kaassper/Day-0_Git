<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Inacap Day 0</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="dashboard-style.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

    <nav class="navbar">
        <div class="navbar-brand">
            <img src="mascot.png" alt="Mascota" class="nav-mascot">
            <span>Inacap Day 0</span>
        </div>
        <div class="nav-menu">
            <span id="nav-username"></span>
            <a href="dashboard.html" class="nav-btn active">Panel</a>
            <a href="missions.html" class="nav-btn">Misiones</a>
            <button id="logout-button" class="logout-btn">Cerrar Sesi贸n</button>
        </div>
    </nav>

    <main class="main-container">

        <h1 id="welcome-title">隆Hola, ...!</h1>

        <div class="widgets-grid">
            <div class="widget points-card">
                <h2>Inacapuntos</h2>
                <div class="points-display">
                    <img src="coin_icon.png" alt="Moneda" class="coin-icon-img">
                    <span id="points-amount">0</span>
                </div>
            </div>

            <div class="widget qr-card">
                <h2>Escanear QR</h2>
                <p>Encuentra c贸digos en la sede para ganar puntos extra.</p>
                <button class="widget-btn" id="btn-scan-qr"> Abrir C谩mara</button>
            </div>
            
            <div class="widget map-card">
                <h2>Mapa Sede</h2>
                <p>Explora la sede y encuentra tus salas.</p>
                <button class="widget-btn">Ver Mapa</button>
            </div>
        </div> 

        <div class="widget mission-link-card" onclick="location.href='missions.html'">
            <h2>M贸dulos de Aprendizaje</h2>
            <p>Completa los m贸dulos de 7 preguntas para avanzar.</p>
            <button class="widget-btn">Ir a los M贸dulos</button>
        </div>

    </main>

    <div id="qr-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Escanear C贸digo</h2>
            <div id="reader" style="width: 100%;"></div>
            <p id="qr-result-text">Apunta tu c谩mara al c贸digo QR</p>
            <button id="close-qr-btn" class="widget-btn" style="background-color: #555; margin-top: 10px;">Cerrar C谩mara</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('accessToken');
        const username = localStorage.getItem('username');

        if (!token) { window.location.href = 'login.html'; return; }
        
        // Cargar datos iniciales
        fetchUserData(token);

        // --- LGICA QR ---
        const qrModal = document.getElementById('qr-modal');
        const btnScanQr = document.getElementById('btn-scan-qr');
        const btnCloseQr = document.getElementById('close-qr-btn');
        const qrResultText = document.getElementById('qr-result-text');
        let html5QrcodeScanner = null;

        btnScanQr.addEventListener('click', () => {
            qrModal.style.display = 'flex';
            startScanner();
        });

        btnCloseQr.addEventListener('click', () => {
            stopScanner();
            qrModal.style.display = 'none';
        });

        function startScanner() {
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", { fps: 10, qrbox: 250 }
            );
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch(error => console.error(error));
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            // 隆CDIGO ENCONTRADO!
            stopScanner(); // Detenemos la c谩mara
            qrResultText.textContent = "Procesando: " + decodedText;
            
            // Enviamos el c贸digo al backend como si fuera una misi贸n
            // (Usamos el texto del QR como el 'missionName')
            const success = await completeMissionOnBackend(decodedText, 50); // 50 puntos por QR
            
            if (success) {
                alert(`隆xito! Has escaneado: ${decodedText} y ganado 50 puntos.`);
                fetchUserData(token); // Actualizamos los puntos en pantalla
                qrModal.style.display = 'none';
            } else {
                qrResultText.textContent = "Error: C贸digo inv谩lido o ya escaneado.";
            }
        }

        function onScanFailure(error) {
            // console.warn(`Code scan error = ${error}`);
        }

        // --- FUNCIONES EXISTENTES ---
        document.getElementById('logout-button').addEventListener('click', () => {
            localStorage.clear();
            window.location.href = 'login.html';
        });

        async function fetchUserData(token) {
            try {
                const response = await fetch('https://day-0-git.onrender.com/api/users/me', {
                    method: 'GET', headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const userData = await response.json();
                    document.getElementById('points-amount').textContent = userData.puntos;
                    document.getElementById('welcome-title').textContent = `隆Hola, ${userData.username}!`;
                    document.getElementById('nav-username').textContent = `Usuario: ${userData.username}`;
                }
            } catch (error) { console.error(error); }
        }

        // Reutilizamos la funci贸n de completar misi贸n para los QRs
        async function completeMissionOnBackend(missionName, pointsToAdd) {
            try {
                const response = await fetch('https://day-0-git.onrender.com/api/missions/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ missionName: missionName, pointsToAdd: pointsToAdd })
                });
                return response.ok;
            } catch (error) { return false; }
        }
    });
    </script>
</body>
</html>