<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misiones - Inacap Day 0</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="dashboard-style.css">
    <link rel="stylesheet" href="missions-style.css">
</head>
<body>

    <nav class="navbar">
        <div class="navbar-brand">
            <img src="mascot.png" alt="Mascota" class="nav-mascot">
            <span>Inacap Day 0</span>
        </div>
        <div class="nav-menu">
            <span id="nav-username"></span>
            <a href="dashboard.html" class="nav-btn">Panel</a>
            <a href="missions.html" class="nav-btn active">Misiones</a>
            <button id="logout-button" class="logout-btn">Cerrar Sesi√≥n</button>
        </div>
    </nav>

    <main class="main-container">
        <h1>Ruta de Misiones</h1>
        
        <div class="mission-path">
            <div class="mission-node completed">
                <span class="node-icon">‚úÖ</span>
                <h3>Crea tu Cuenta</h3>
                <p>¬°Bienvenido a la aventura!</p>
                <button class="mission-btn" disabled>Completado</button>
            </div>

            <div class="mission-node active">
                <span class="node-icon">üó∫Ô∏è</span>
                <h3>Conoce tu Sede</h3>
                <p>Completa el quiz sobre la sede.</p>
                <button class="mission-btn" id="start-quiz-conoce-tu-sede">¬°Comenzar Quiz!</button>
            </div>

            <div class="mission-node locked">
                <span class="node-icon">üîí</span>
                <h3>Escaneo QR</h3>
                <p>Encuentra y escanea tu primer c√≥digo QR.</p>
                <button class="mission-btn" disabled>Bloqueado</button>
            </div>

            <div class="mission-node locked special">
                <span class="node-icon">üèÜ</span>
                <h3>Recompensa</h3>
                <p>¬°100 Inacapuntos!</p>
                <button class="mission-btn" disabled>Bloqueado</button>
            </div>

            <div class="mission-node locked">
                <span class="node-icon">üîí</span>
                <h3>Visita el Co-Work</h3>
                <p>Escanea el QR de la entrada del Co-Work.</p>
                <button class="mission-btn" disabled>Bloqueado</button>
            </div>
        </div>

    </main>

    
    <div id="briefing-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="briefing-title"></h2>
            <p id="briefing-desc"></p>
            
            <div class="briefing-buttons">
                <button id="briefing-exit-btn" class="modal-btn-exit">Salir</button>
                <button id="briefing-start-btn" class="modal-btn-start">¬°Comenzar!</button>
            </div>
        </div>
    </div>

    <div id="quiz-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            
            <div id="quiz-step-info">
                <h2 id="quiz-info-title"></h2>
                <p id="quiz-info-text"></p>

                <div id="quiz-final-score" style="display: none;">
                    <p id="quiz-score-text">Tu puntaje: 0 de 3 (0%)</p>
                    <div class="progress-bar-container">
                        <div id="progress-bar-fill"></div>
                    </div>
                </div>
            </div>

            <div id="quiz-step-question" style="display: none;">
                <h2 id="quiz-question-text"></h2>
                <div id="quiz-options-container" class="quiz-options">
                    </div>
            </div>

            <button id="quiz-next-btn">Siguiente</button>
            <button id="quiz-close-btn" style="display: none;">Cerrar</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('accessToken');
            const username = localStorage.getItem('username');

            // 1. PROTECCI√ìN DE RUTA
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            if (username) {
                document.getElementById('nav-username').textContent = `Usuario: ${username}`;
            }
            
            // 2. LOGOUT
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.clear();
                window.location.href = 'login.html';
            });

            // --- 3. L√ìGICA DE MISIONES Y QUIZ (VERSI√ìN 3.0 CON BACKEND) ---
            
            // --- Referencias a Elementos ---
            const briefingModal = document.getElementById('briefing-modal');
            const briefingTitle = document.getElementById('briefing-title');
            const briefingDesc = document.getElementById('briefing-desc');
            const briefingStartBtn = document.getElementById('briefing-start-btn');
            const briefingExitBtn = document.getElementById('briefing-exit-btn');
            
            const quizModal = document.getElementById('quiz-modal');
            const nextBtn = document.getElementById('quiz-next-btn');
            const closeBtn = document.getElementById('quiz-close-btn');
            
            const infoStep = document.getElementById('quiz-step-info');
            const questionStep = document.getElementById('quiz-step-question');
            const infoTitle = document.getElementById('quiz-info-title');
            const infoText = document.getElementById('quiz-info-text');
            const questionText = document.getElementById('quiz-question-text');
            const optionsContainer = document.getElementById('quiz-options-container');

            const finalScoreDisplay = document.getElementById('quiz-final-score');
            const scoreText = document.getElementById('quiz-score-text');
            const progressBarFill = document.getElementById('progress-bar-fill');

            const startQuizNodeBtn = document.getElementById('start-quiz-conoce-tu-sede');

            // --- Datos del Quiz ---
            const quizData = [
                { type: "info", title: "¬°Bienvenido a 'Conoce tu Sede'!", text: "Vamos a repasar la informaci√≥n de los pisos. Lee con atenci√≥n y luego responde las preguntas." },
                { type: "info", title: "Piso 1 y 3", text: "En el Piso 1 se encuentra el DAE y Curricular. En el Piso 3 tienes un kiosco y la entrada al Co-Work." },
                { type: "question", question: "¬øEn qu√© piso se encuentra el DAE?", options: ["Piso 2", "Piso -1", "Piso 1", "Piso 3"], correctAnswer: "Piso 1" },
                { type: "info", title: "Piso 2 y -1", text: "En el Piso 2 se encuentra la sala de Directores de Carrera. En el Piso -1 est√° el acceso a los talleres de Electr√≥nica, Mec√°nica y Dise√±o Gr√°fico." },
                { type: "question", question: "¬øD√≥nde encuentras los talleres de Mec√°nica?", options: ["Piso 3", "Piso -1", "Piso 1", "Piso 2"], correctAnswer: "Piso -1" }, // Corregido
                { type: "question", question: "Si buscas a tu Director de Carrera, ¬øa qu√© piso debes ir?", options: ["Piso 1", "Piso 3", "Piso 2", "Piso -1"], correctAnswer: "Piso 2" },
                { type: "info", title: "¬°Quiz Finalizado!", text: "Veamos c√≥mo te fue..." } // Paso final
            ];

            // --- Variables de Estado ---
            let currentStep = 0;
            let selectedAnswer = null;
            let score = 0;
            const totalQuestions = quizData.filter(step => step.type === "question").length;

            // --- Event Listeners ---
            startQuizNodeBtn.addEventListener('click', openBriefing);
            briefingExitBtn.addEventListener('click', closeBriefing);
            briefingStartBtn.addEventListener('click', () => {
                closeBriefing();
                startQuiz(); 
            });
            nextBtn.addEventListener('click', nextQuizStep);
            closeBtn.addEventListener('click', closeQuiz);

            // --- Funciones del Flujo ---

            function openBriefing() {
                briefingTitle.textContent = "Nueva Misi√≥n: Conoce tu Sede";
                briefingDesc.textContent = "Se te presentar√° informaci√≥n sobre la sede, seguida de un breve quiz. Al final ver√°s tu puntaje. ¬øEst√°s listo?";
                briefingModal.style.display = 'flex';
            }

            function closeBriefing() {
                briefingModal.style.display = 'none';
            }

            function startQuiz() {
                currentStep = 0;
                score = 0;
                quizModal.style.display = 'flex';
                
                nextBtn.style.display = 'block';
                closeBtn.style.display = 'none';
                
                startQuizNodeBtn.textContent = "¬°Comenzar Quiz!";
                startQuizNodeBtn.disabled = false;
                
                showQuizStep(currentStep);
            }

            function closeQuiz() {
                quizModal.style.display = 'none';
            }

            function showQuizStep(stepIndex) {
                const step = quizData[stepIndex];
                selectedAnswer = null;
                finalScoreDisplay.style.display = 'none'; 

                if (step.type === "info") {
                    infoStep.style.display = 'block';
                    questionStep.style.display = 'none';
                    infoTitle.textContent = step.title;
                    infoText.textContent = step.text;
                    
                    if (stepIndex === quizData.length - 1) {
                        nextBtn.style.display = 'none';
                        closeBtn.style.display = 'block';
                        showFinalScore(); 
                    } else {
                        nextBtn.style.display = 'block';
                        closeBtn.style.display = 'none';
                    }
                    
                } else if (step.type === "question") {
                    infoStep.style.display = 'none';
                    questionStep.style.display = 'block';
                    nextBtn.style.display = 'block';
                    closeBtn.style.display = 'none';
                    questionText.textContent = step.question;
                    optionsContainer.innerHTML = '';
                    step.options.forEach(optionText => {
                        const btn = document.createElement('button');
                        btn.className = 'quiz-option-btn';
                        btn.textContent = optionText;
                        btn.addEventListener('click', () => {
                            document.querySelectorAll('.quiz-option-btn').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            selectedAnswer = optionText;
                        });
                        optionsContainer.appendChild(btn);
                    });
                }
            }

            function nextQuizStep() {
                const currentQuizData = quizData[currentStep];
                if (currentQuizData.type === "question") {
                    if (selectedAnswer === null) {
                        alert("Por favor, selecciona una respuesta.");
                        return;
                    }
                    if (selectedAnswer === currentQuizData.correctAnswer) {
                        score++;
                    }
                }
                currentStep++;
                if (currentStep < quizData.length) {
                    showQuizStep(currentStep);
                }
            }

            async function showFinalScore() {
                const percentage = (score / totalQuestions) * 100;
                
                finalScoreDisplay.style.display = 'block';
                scoreText.textContent = `Tu puntaje: ${score} de ${totalQuestions} correctas (${percentage.toFixed(0)}%)`;
                
                progressBarFill.style.width = `${percentage}%`;
                progressBarFill.textContent = `${percentage.toFixed(0)}%`;

                if (percentage >= 80) {
                    progressBarFill.classList.remove('fail');
                    infoText.textContent = "¬°Excelente! Has aprobado la misi√≥n."; 

                    try {
                        const success = await completeMissionOnBackend("Conoce tu sede test prueba", 150);
                        if (success) {
                            startQuizNodeBtn.textContent = "¬°Completado!";
                            startQuizNodeBtn.disabled = true;
                            const node = startQuizNodeBtn.closest('.mission-node');
                            node.classList.remove('active');
                            node.classList.add('completed');
                            
                            const nextMission = document.querySelector('.mission-node.locked');
                            if (nextMission) {
                                nextMission.classList.remove('locked');
                                nextMission.classList.add('active');
                                nextMission.querySelector('.mission-btn').disabled = false;
                            }
                        }
                    } catch (error) {
                        infoText.textContent = "¬°Aprobaste! Pero hubo un error al guardar tu puntaje.";
                    }

                } else {
                    progressBarFill.classList.add('fail');
                    infoText.textContent = "¬°No lograste el 80%! Vuelve a intentarlo.";
                }
            }

            async function completeMissionOnBackend(missionName, pointsToAdd) {
                const token = localStorage.getItem('accessToken');
                try {
                    const response = await fetch('http://localhost:5000/api/missions/complete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            missionName: missionName,
                            pointsToAdd: pointsToAdd
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Error del backend:", errorData.message);
                        return false;
                    }

                    const result = await response.json();
                    console.log(result.message); 
                    return true;

                } catch (error) {
                    console.error("Error de conexi√≥n al guardar misi√≥n:", error);
                    return false;
                }
            }

        }); 
    </script>

</body>
</html>