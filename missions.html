<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M贸dulos - Inacap Day 0</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="dashboard-style.css">
    <link rel="stylesheet" href="missions-style.css">
</head>
<body>

    <nav class="navbar">
        <div class="navbar-brand">
            <img src="mascot.png" alt="Mascota" class="nav-mascot">
            <span>Inacap Day 0</span>
        </div>
        <div class="nav-menu">
            <span id="nav-username"></span>
            <a href="dashboard.html" class="nav-btn">Panel</a>
            <a href="missions.html" class="nav-btn active">M贸dulos</a>
            <button id="logout-button" class="logout-btn">Cerrar Sesi贸n</button>
        </div>
    </nav>

    <main class="main-container">
        <h1>Ruta de Aprendizaje</h1>
        
        <div class="mission-path">
            
            <div class="mission-node active" id="node-modulo-1">
                <span class="node-icon"></span>
                <h3>M贸dulo 1: Inducci贸n</h3>
                <p>Conoce lo b谩sico de tu sede.</p>
                <button class="mission-btn" onclick="openModule('modulo1')">Comenzar M贸dulo</button>
            </div>

            <div class="mission-node locked" id="node-modulo-2">
                <span class="node-icon"></span>
                <h3>M贸dulo 2: Vida Acad茅mica</h3>
                <p>Aprende sobre DAE y tus beneficios.</p>
                <button class="mission-btn" disabled onclick="openModule('modulo2')">Bloqueado</button>
            </div>
            
            <div class="mission-node locked" id="node-modulo-3">
                <span class="node-icon"></span>
                <h3>M贸dulo 3: Innovaci贸n</h3>
                <p>Talleres, FabLab y Cowork.</p>
                <button class="mission-btn" disabled>Bloqueado</button>
            </div>

        </div>
    </main>

    <div id="briefing-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="briefing-title"></h2>
            <p id="briefing-desc"></p>
            <div class="briefing-buttons">
                <button id="briefing-exit-btn" class="modal-btn-exit">Salir</button>
                <button id="briefing-start-btn" class="modal-btn-start">隆Comenzar!</button>
            </div>
        </div>
    </div>

    <div id="quiz-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div id="quiz-step-info">
                <h2 id="quiz-info-title"></h2>
                <p id="quiz-info-text"></p>
                <div id="quiz-final-score" style="display: none;">
                    <p id="quiz-score-text"></p>
                    <div class="progress-bar-container">
                        <div id="progress-bar-fill"></div>
                    </div>
                </div>
            </div>
            <div id="quiz-step-question" style="display: none;">
                <h2 id="quiz-question-text"></h2>
                <div id="quiz-options-container" class="quiz-options"></div>
            </div>
            <button id="quiz-next-btn">Siguiente</button>
            <button id="quiz-close-btn" style="display: none;">Cerrar</button>
        </div>
    </div>

    <script>
        // DATOS DE LOS MDULOS (7 PREGUNTAS CADA UNO)
        const modulesData = {
            "modulo1": {
                title: "M贸dulo 1: Inducci贸n",
                desc: "Este m贸dulo cubre la ubicaci贸n de las 谩reas clave de la sede. Debes acertar al menos el 80% de las 7 preguntas.",
                questions: [
                    { q: "驴En qu茅 piso est谩 el DAE?", options: ["Piso 1", "Piso 2", "Piso -1"], ans: "Piso 1" },
                    { q: "驴D贸nde sacas la TNE?", options: ["Biblioteca", "DAE", "Kiosco"], ans: "DAE" },
                    { q: "驴D贸nde est谩n los directores de carrera?", options: ["Piso 2", "Piso 3", "Piso 1"], ans: "Piso 2" },
                    { q: "驴Qu茅 hay en el piso 3?", options: ["Talleres", "Co-Work", "Casino"], ans: "Co-Work" },
                    { q: "驴D贸nde est谩n los talleres mec谩nicos?", options: ["Piso -1", "Piso 1", "Patio"], ans: "Piso -1" },
                    { q: "驴Cu谩l es el horario de biblioteca?", options: ["24/7", "8:00 a 22:00", "9:00 a 18:00"], ans: "8:00 a 22:00" }, // Ejemplo
                    { q: "驴D贸nde pides ayuda acad茅mica?", options: ["Curricular", "Guardia", "Kiosco"], ans: "Curricular" }
                ]
            },
            "modulo2": {
                title: "M贸dulo 2: Vida Acad茅mica",
                desc: "Preguntas sobre reglamentos y beneficios.",
                questions: [
                    { q: "驴Qu茅 es la carga acad茅mica?", options: ["Peso de mochila", "Asignaturas inscritas", "Estr茅s"], ans: "Asignaturas inscritas" },
                    { q: "驴D贸nde ves tus notas?", options: ["Intranet", "Diario mural", "Secretar铆a"], ans: "Intranet" },
                    { q: "驴Cuanto asistencia necesitas para aprobar?", options: ["50%", "60%", "No importa"], ans: "60%" }, // Ejemplo
                    { q: "驴Qu茅 es el RAA?", options: ["Un robot", "Reglamento Acad茅mico", "Red de Alumnos"], ans: "Reglamento Acad茅mico" },
                    { q: "驴D贸nde renuevas el CAE?", options: ["DAE", "Finanzas", "Biblioteca"], ans: "DAE" },
                    { q: "驴Qu茅 pasa si repruebas 3 veces?", options: ["Nada", "Eliminaci贸n", "Premio"], ans: "Eliminaci贸n" },
                    { q: "驴D贸nde justificas inasistencias?", options: ["Director carrera", "Profesor", "DAE"], ans: "Director carrera" }
                ]
            }
        };

        let currentModuleId = null;
        let currentModuleQuestions = [];
        let currentStep = 0;
        let score = 0;
        let selectedAnswer = null;

        // --- INICIO DEL SCRIPT ---
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('accessToken');
            const username = localStorage.getItem('username');

            if (!token) { window.location.href = 'login.html'; return; }
            if (username) document.getElementById('nav-username').textContent = `Usuario: ${username}`;
            
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.clear(); window.location.href = 'login.html';
            });

            loadModulesStatus(token); // Cargar qu茅 m贸dulos ya complet贸
        });

        // --- FUNCIONES GLOBALES (Para el onclick del HTML) ---
        window.openModule = function(moduleId) {
            currentModuleId = moduleId;
            const data = modulesData[moduleId];
            currentModuleQuestions = data.questions;

            // Configurar Briefing
            document.getElementById('briefing-title').textContent = data.title;
            document.getElementById('briefing-desc').textContent = data.desc;
            
            document.getElementById('briefing-start-btn').onclick = function() {
                document.getElementById('briefing-modal').style.display = 'none';
                startQuiz();
            };
            document.getElementById('briefing-exit-btn').onclick = function() {
                document.getElementById('briefing-modal').style.display = 'none';
            };

            document.getElementById('briefing-modal').style.display = 'flex';
        }

        // --- LGICA DEL QUIZ ---
        const quizModal = document.getElementById('quiz-modal');
        const nextBtn = document.getElementById('quiz-next-btn');
        const closeBtn = document.getElementById('quiz-close-btn');

        nextBtn.addEventListener('click', nextStep);
        closeBtn.addEventListener('click', () => {
            quizModal.style.display = 'none';
            // Recargar estado para desbloquear siguiente si aprob贸
            const token = localStorage.getItem('accessToken');
            loadModulesStatus(token); 
        });

        function startQuiz() {
            currentStep = 0;
            score = 0;
            quizModal.style.display = 'flex';
            nextBtn.style.display = 'block';
            closeBtn.style.display = 'none';
            document.getElementById('quiz-final-score').style.display = 'none';
            showQuestion(0);
        }

        function showQuestion(index) {
            selectedAnswer = null;
            document.getElementById('quiz-step-info').style.display = 'none';
            document.getElementById('quiz-step-question').style.display = 'block';
            
            const qData = currentModuleQuestions[index];
            document.getElementById('quiz-question-text').textContent = `P${index+1}: ${qData.q}`;
            
            const container = document.getElementById('quiz-options-container');
            container.innerHTML = '';
            
            qData.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option-btn';
                btn.textContent = opt;
                btn.onclick = () => {
                    document.querySelectorAll('.quiz-option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedAnswer = opt;
                };
                container.appendChild(btn);
            });
        }

        function nextStep() {
            if (!selectedAnswer) { alert("Elige una opci贸n"); return; }
            
            // Verificar respuesta
            if (selectedAnswer === currentModuleQuestions[currentStep].ans) {
                score++;
            }

            currentStep++;
            if (currentStep < currentModuleQuestions.length) {
                showQuestion(currentStep);
            } else {
                finishQuiz();
            }
        }

        function finishQuiz() {
            document.getElementById('quiz-step-question').style.display = 'none';
            document.getElementById('quiz-step-info').style.display = 'block';
            nextBtn.style.display = 'none';
            closeBtn.style.display = 'block';

            const total = currentModuleQuestions.length;
            const percentage = (score / total) * 100;
            
            const title = document.getElementById('quiz-info-title');
            const text = document.getElementById('quiz-info-text');
            const scoreBlock = document.getElementById('quiz-final-score');
            const bar = document.getElementById('progress-bar-fill');
            
            scoreBlock.style.display = 'block';
            document.getElementById('quiz-score-text').textContent = `${score}/${total} (${percentage.toFixed(0)}%)`;
            bar.style.width = `${percentage}%`;
            bar.textContent = `${percentage.toFixed(0)}%`;

            if (percentage >= 80) {
                bar.classList.remove('fail');
                title.textContent = "隆M贸dulo Aprobado!";
                text.textContent = "Has desbloqueado el siguiente nivel.";
                // Guardar en backend
                completeMissionOnBackend(currentModuleId, 200); // 200 puntos por m贸dulo
            } else {
                bar.classList.add('fail');
                title.textContent = "M贸dulo Reprobado";
                text.textContent = "Necesitas un 80% para aprobar. Int茅ntalo de nuevo.";
            }
        }

        async function loadModulesStatus(token) {
            try {
                const res = await fetch('https://day-0-git.onrender.com/api/users/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const user = await res.json();
                    const completed = user.rutas_completas || [];

                    // L贸gica de desbloqueo
                    if (completed.includes("modulo1")) {
                        markAsCompleted("node-modulo-1", "modulo1");
                        unlock("node-modulo-2", "modulo2");
                    }
                    if (completed.includes("modulo2")) {
                        markAsCompleted("node-modulo-2", "modulo2");
                        unlock("node-modulo-3", "modulo3");
                    }
                    // etc...
                }
            } catch (e) { console.error(e); }
        }

        function markAsCompleted(nodeId, modId) {
            const node = document.getElementById(nodeId);
            if (node) {
                node.classList.remove('active', 'locked');
                node.classList.add('completed');
                const btn = node.querySelector('button');
                btn.textContent = "Completado";
                btn.disabled = true;
            }
        }

        function unlock(nodeId, modId) {
            const node = document.getElementById(nodeId);
            if (node && !node.classList.contains('completed')) {
                node.classList.remove('locked');
                node.classList.add('active');
                const btn = node.querySelector('button');
                btn.textContent = "Comenzar M贸dulo";
                btn.disabled = false;
                // Actualiza el onclick para asegurar que apunte al m贸dulo correcto
                btn.onclick = function() { openModule(modId); }; 
            }
        }

        async function completeMissionOnBackend(name, points) {
            const token = localStorage.getItem('accessToken');
            await fetch('https://day-0-git.onrender.com/api/missions/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ missionName: name, pointsToAdd: points })
            });
        }
    </script>
</body>
</html>