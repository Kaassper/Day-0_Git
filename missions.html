<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulos - Inacap Day 0</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="dashboard-style.css">
    <link rel="stylesheet" href="missions-style.css">
</head>
<body>

    <nav class="navbar">
        <div class="navbar-brand">
            <img src="mascot.png" alt="Mascota" class="nav-mascot">
            <span>Inacap Day 0</span>
        </div>
        <div class="nav-menu">
            <span id="nav-username"></span>
            <a href="dashboard.html" class="nav-btn">Panel</a>
            <a href="missions.html" class="nav-btn active">M√≥dulos</a>
            <button id="logout-button" class="logout-btn">Cerrar Sesi√≥n</button>
        </div>
    </nav>

    <main class="main-container">
        <h1>Ruta de Aprendizaje</h1>
        
        <div class="mission-path">
            
            <div class="mission-node active" id="node-modulo-1">
                <span class="node-icon">üìö</span>
                <h3>M√≥dulo 1: Inducci√≥n</h3>
                <p>Ubicaci√≥n de √°reas clave en la sede.</p>
                <button class="mission-btn" onclick="openModule('modulo1')">Comenzar M√≥dulo</button>
            </div>

            <div class="mission-node locked" id="node-modulo-2">
                <span class="node-icon">üéì</span>
                <h3>M√≥dulo 2: Vida Acad√©mica</h3>
                <p>Reglamentos, DAE y beneficios.</p>
                <button class="mission-btn" disabled onclick="openModule('modulo2')">Bloqueado</button>
            </div>
            
            <div class="mission-node locked" id="node-modulo-3">
                <span class="node-icon">üöÄ</span>
                <h3>M√≥dulo 3: Innovaci√≥n</h3>
                <p>Talleres, FabLab y Cowork.</p>
                <button class="mission-btn" disabled>Bloqueado</button>
            </div>

        </div>
    </main>

    <div id="briefing-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="briefing-title"></h2>
            <p id="briefing-desc"></p>
            
            <div class="briefing-buttons">
                <button id="briefing-exit-btn" class="modal-btn-exit">Salir</button>
                <button id="briefing-review-btn" class="modal-btn-review">üìñ Repasar</button>
                <button id="briefing-start-btn" class="modal-btn-start">¬°Comenzar!</button>
            </div>
        </div>
    </div>

    <div id="study-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content study-content-box">
            <h2>Material de Estudio</h2>
            <div id="study-content-text" class="scrollable-content">
                </div>
            <button id="study-close-btn" class="widget-btn" style="margin-top: 15px;">¬°Listo, volver al men√∫!</button>
        </div>
    </div>

    <div id="quiz-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            
            <div id="quiz-step-info">
                <h2 id="quiz-info-title"></h2>
                <p id="quiz-info-text"></p>
                <div id="quiz-final-score" style="display: none;">
                    <p id="quiz-score-text"></p>
                    <div class="progress-bar-container">
                        <div id="progress-bar-fill"></div>
                    </div>
                </div>
            </div>
            
            <div id="quiz-step-question" style="display: none;">
                <h2 id="quiz-question-text"></h2>
                <div id="quiz-options-container" class="quiz-options"></div>
            </div>
            
            <button id="quiz-next-btn">Siguiente</button>
            <button id="quiz-close-btn" style="display: none;">Cerrar</button>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS DE PREGUNTAS Y MATERIAL DE ESTUDIO ---
        const modulesData = {
            "modulo1": {
                title: "M√≥dulo 1: Inducci√≥n",
                desc: "Este m√≥dulo cubre la ubicaci√≥n de las √°reas clave de la sede. Debes acertar al menos el 80% de las 7 preguntas.",
                studyContent: `
                    <h4>üè¢ Primer Piso (Nivel 1)</h4>
                    <ul>
                        <li><strong>DAE:</strong> Aqu√≠ obtienes tu TNE y ayudas estudiantiles.</li>
                        <li><strong>Curricular:</strong> Certificados y temas de asignaturas.</li>
                    </ul>
                    <h4>üõ†Ô∏è Piso Subterr√°neo (Nivel -1)</h4>
                    <ul>
                        <li><strong>Talleres:</strong> Mec√°nica, Electr√≥nica y Dise√±o.</li>
                    </ul>
                    <h4>üë®‚Äçüè´ Segundo Piso (Nivel 2)</h4>
                    <ul>
                        <li><strong>Directores de Carrera:</strong> Sus oficinas est√°n aqu√≠.</li>
                    </ul>
                    <h4>üíª Tercer Piso (Nivel 3)</h4>
                    <ul>
                        <li><strong>Co-Work:</strong> Espacio de trabajo colaborativo.</li>
                        <li><strong>Kiosco:</strong> Zona de alimentaci√≥n.</li>
                    </ul>
                    <h4>üìö Biblioteca</h4>
                    <p>Horario: <strong>8:00 a 22:00 horas</strong>.</p>
                `,
                questions: [
                    { q: "¬øEn qu√© piso est√° el DAE?", options: ["Piso 1", "Piso 2", "Piso -1"], ans: "Piso 1" },
                    { q: "¬øD√≥nde sacas la TNE?", options: ["Biblioteca", "DAE", "Kiosco"], ans: "DAE" },
                    { q: "¬øD√≥nde est√°n los directores de carrera?", options: ["Piso 2", "Piso 3", "Piso 1"], ans: "Piso 2" },
                    { q: "¬øQu√© hay en el piso 3?", options: ["Talleres", "Co-Work", "Casino"], ans: "Co-Work" },
                    { q: "¬øD√≥nde est√°n los talleres mec√°nicos?", options: ["Piso -1", "Piso 1", "Patio"], ans: "Piso -1" },
                    { q: "¬øCu√°l es el horario de biblioteca?", options: ["24/7", "8:00 a 22:00", "9:00 a 18:00"], ans: "8:00 a 22:00" },
                    { q: "¬øD√≥nde pides ayuda acad√©mica?", options: ["Curricular", "Guardia", "Kiosco"], ans: "Curricular" }
                ]
            },
            "modulo2": {
                title: "M√≥dulo 2: Vida Acad√©mica",
                desc: "Preguntas sobre reglamentos y beneficios. ¬°Repasa los conceptos clave!",
                studyContent: `
                    <h4>üìù Carga Acad√©mica</h4>
                    <p>Son las <strong>asignaturas inscritas</strong> en tu semestre.</p>
                    <h4>üåê Intranet</h4>
                    <p>Plataforma para ver <strong>notas</strong>, horario y asistencia.</p>
                    <h4>‚úÖ Asistencia</h4>
                    <p>M√≠nimo para aprobar: <strong>60%</strong> (revisar reglamento espec√≠fico).</p>
                    <h4>üìú RAA</h4>
                    <p><strong>Reglamento Acad√©mico del Alumno</strong>: tus derechos y deberes.</p>
                    <h4>üí∞ CAE</h4>
                    <p>Tr√°mites de cr√©dito y becas se ven en el <strong>DAE</strong>.</p>
                    <h4>‚ö†Ô∏è Reprobaci√≥n</h4>
                    <p>Reprobar 3 veces la misma asignatura es causal de <strong>Eliminaci√≥n</strong>.</p>
                `,
                questions: [
                    { q: "¬øQu√© es la carga acad√©mica?", options: ["Mochila", "Asignaturas inscritas", "Estr√©s"], ans: "Asignaturas inscritas" },
                    { q: "¬øD√≥nde ves tus notas?", options: ["Intranet", "Diario mural", "Secretar√≠a"], ans: "Intranet" },
                    { q: "¬øCuanto asistencia necesitas para aprobar?", options: ["50%", "60%", "No importa"], ans: "60%" },
                    { q: "¬øQu√© es el RAA?", options: ["Un robot", "Reglamento Acad√©mico", "Red de Alumnos"], ans: "Reglamento Acad√©mico" },
                    { q: "¬øD√≥nde renuevas el CAE?", options: ["DAE", "Finanzas", "Biblioteca"], ans: "DAE" },
                    { q: "¬øQu√© pasa si repruebas 3 veces?", options: ["Nada", "Eliminaci√≥n", "Premio"], ans: "Eliminaci√≥n" },
                    { q: "¬øD√≥nde justificas inasistencias?", options: ["Director carrera", "Profesor", "DAE"], ans: "Director carrera" }
                ]
            }
        };

        let currentModuleId = null;
        let currentModuleQuestions = [];
        let currentStep = 0;
        let score = 0;
        let selectedAnswer = null;

        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('accessToken');
            const username = localStorage.getItem('username');

            if (!token) { window.location.href = 'login.html'; return; }
            if (username) document.getElementById('nav-username').textContent = `Usuario: ${username}`;
            
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.clear(); window.location.href = 'login.html';
            });

            loadModulesStatus(token); // Carga el progreso desde la nube
        });

        // --- FUNCIONES DE APERTURA DE M√ìDULO ---
        window.openModule = function(moduleId) {
            currentModuleId = moduleId;
            const data = modulesData[moduleId];
            currentModuleQuestions = data.questions;

            // Llenar Briefing
            document.getElementById('briefing-title').textContent = data.title;
            document.getElementById('briefing-desc').textContent = data.desc;
            
            // Configurar Botones
            document.getElementById('briefing-start-btn').onclick = function() {
                document.getElementById('briefing-modal').style.display = 'none';
                startQuiz();
            };
            document.getElementById('briefing-exit-btn').onclick = function() {
                document.getElementById('briefing-modal').style.display = 'none';
            };
            
            // Bot√≥n REPASAR
            document.getElementById('briefing-review-btn').onclick = function() {
                document.getElementById('briefing-modal').style.display = 'none';
                document.getElementById('study-modal').style.display = 'flex';
                document.getElementById('study-content-text').innerHTML = data.studyContent;
            };

            document.getElementById('briefing-modal').style.display = 'flex';
        }

        // Bot√≥n cerrar estudio
        document.getElementById('study-close-btn').addEventListener('click', () => {
            document.getElementById('study-modal').style.display = 'none';
            document.getElementById('briefing-modal').style.display = 'flex';
        });

        // --- L√ìGICA DEL QUIZ ---
        const quizModal = document.getElementById('quiz-modal');
        const nextBtn = document.getElementById('quiz-next-btn');
        const closeBtn = document.getElementById('quiz-close-btn');

        nextBtn.addEventListener('click', nextStep);
        closeBtn.addEventListener('click', () => {
            quizModal.style.display = 'none';
            const token = localStorage.getItem('accessToken');
            loadModulesStatus(token); // Recargar para desbloquear si corresponde
        });

        function startQuiz() {
            currentStep = 0;
            score = 0;
            quizModal.style.display = 'flex';
            nextBtn.style.display = 'block';
            closeBtn.style.display = 'none';
            document.getElementById('quiz-final-score').style.display = 'none';
            showQuestion(0);
        }

        function showQuestion(index) {
            selectedAnswer = null;
            document.getElementById('quiz-step-info').style.display = 'none';
            document.getElementById('quiz-step-question').style.display = 'block';
            
            const qData = currentModuleQuestions[index];
            document.getElementById('quiz-question-text').textContent = `P${index+1}: ${qData.q}`;
            
            const container = document.getElementById('quiz-options-container');
            container.innerHTML = '';
            
            qData.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option-btn';
                btn.textContent = opt;
                btn.onclick = () => {
                    document.querySelectorAll('.quiz-option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedAnswer = opt;
                };
                container.appendChild(btn);
            });
        }

        function nextStep() {
            if (!selectedAnswer) { alert("Elige una opci√≥n"); return; }
            
            if (selectedAnswer === currentModuleQuestions[currentStep].ans) {
                score++;
            }

            currentStep++;
            if (currentStep < currentModuleQuestions.length) {
                showQuestion(currentStep);
            } else {
                finishQuiz();
            }
        }

        function finishQuiz() {
            document.getElementById('quiz-step-question').style.display = 'none';
            document.getElementById('quiz-step-info').style.display = 'block';
            nextBtn.style.display = 'none';
            closeBtn.style.display = 'block';

            const total = currentModuleQuestions.length;
            const percentage = (score / total) * 100;
            
            const title = document.getElementById('quiz-info-title');
            const text = document.getElementById('quiz-info-text');
            const scoreBlock = document.getElementById('quiz-final-score');
            const bar = document.getElementById('progress-bar-fill');
            
            scoreBlock.style.display = 'block';
            document.getElementById('quiz-score-text').textContent = `${score}/${total} correctas (${percentage.toFixed(0)}%)`;
            bar.style.width = `${percentage}%`;
            bar.textContent = `${percentage.toFixed(0)}%`;

            if (percentage >= 80) {
                bar.classList.remove('fail');
                title.textContent = "¬°M√≥dulo Aprobado!";
                text.textContent = "Has desbloqueado el siguiente nivel.";
                completeMissionOnBackend(currentModuleId, 200); // Guardar progreso
            } else {
                bar.classList.add('fail');
                title.textContent = "M√≥dulo Reprobado";
                text.textContent = "Necesitas un 80% para aprobar. ¬°Repasa y vuelve a intentar!";
            }
        }

        async function loadModulesStatus(token) {
            try {
                const res = await fetch('https://day-0-git.onrender.com/api/users/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const user = await res.json();
                    const completed = user.rutas_completas || [];

                    if (completed.includes("modulo1")) {
                        markAsCompleted("node-modulo-1", "modulo1");
                        unlock("node-modulo-2", "modulo2");
                    }
                    if (completed.includes("modulo2")) {
                        markAsCompleted("node-modulo-2", "modulo2");
                        unlock("node-modulo-3", "modulo3");
                    }
                }
            } catch (e) { console.error(e); }
        }

        function markAsCompleted(nodeId, modId) {
            const node = document.getElementById(nodeId);
            if (node) {
                node.classList.remove('active', 'locked');
                node.classList.add('completed');
                const btn = node.querySelector('button');
                btn.textContent = "Completado";
                btn.disabled = true;
            }
        }

        function unlock(nodeId, modId) {
            const node = document.getElementById(nodeId);
            if (node && !node.classList.contains('completed')) {
                node.classList.remove('locked');
                node.classList.add('active');
                const btn = node.querySelector('button');
                btn.textContent = "Comenzar M√≥dulo";
                btn.disabled = false;
                btn.onclick = function() { openModule(modId); }; 
            }
        }

        async function completeMissionOnBackend(name, points) {
            const token = localStorage.getItem('accessToken');
            await fetch('https://day-0-git.onrender.com/api/missions/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ missionName: name, pointsToAdd: points })
            });
        }
    </script>
</body>
</html>